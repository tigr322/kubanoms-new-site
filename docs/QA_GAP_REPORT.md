# QA Gap Report — Legacy Symfony 2.8 → Laravel 12 + Inertia

## 1) Summary
- Публичка готовность (оценка): ~35% — базовый рендер страниц и layout стартуют, но нет полноценных данных из legacy и нет паритета по меню/контенту/страницам.
- Админка готовность (оценка): ~15% — только JSON-заглушки, нет UI/аутентификации/ролей (spatie не подключён, Breeze не установлен).
- Топ‑10 критичных расхождений:
  1. **БД импорт**: миграции читают `../db/*.sql` напрямую. На проде путь может отсутствовать → migrate падает. Нет fallback/конфигурации. (P0)
  2. **Данные**: после migrate таблицы пустые, home `/` и другие URL 404 без ручного импорта/сидов. Нет автоматического импорта дампа или seed из legacy. (P0)
  3. **Auth/Admin**: нет реальной авторизации (Breeze/spatie не установлены), /admin/login отсутствует, админ‑CRUD только JSON. (P0)
  4. **Layout паритет**: меню NAVBAR/SIDEBAR не подтягивается из БД (при пустых таблицах или несоответствии полей), хлебные крошки отсутствуют, баннеры выводятся только если setting есть. (P1)
  5. **RSS**: /rss.xml отдаёт заглушку без элементов, не соответствует legacy RSS. (P1)
  6. **Search**: упрощённый поиск без пагинации/шаблона, нет совпадения с legacy search UI/логикой. (P1)
  7. **Virtual Reception**: форма без вложений/ESIA/валидации поля, минимальная проверка; записи создаются, но нет привязки к rate_limits/sessions как в legacy. (P1)
  8. **Catch-all**: зависимость от данных `cms_page`; резервирование путей только admin/api/rss.xml/search — остальные служебные URL (например, sitemap/esia) могут перехватываться. (P1)
  9. **Статика/стили**: legacy CSS подключены, но нет проверок на 1160px/отступы/hover; без данных меню/контента визуальный вид невалиден. (P2)
  10. **Безопасность**: контент рендерится через `v-html` без санитайза; загрузки файлов не валидируются (файловый модуль заглушка); CSP заглушка отсутствует. (P1)

## 2) Route Parity (Legacy vs New)

| URL | Legacy | New | Notes |
| --- | --- | --- | --- |
| `/` | 200, home with tabs | 404 без данных; 200 при наличии cms_page `/` | Нужен импорт/сидирование home |
| `/grazhd.html` | 200 | 404 без данных; 200 при наличии страницы | Нет breadcrumbs/меню |
| `/mo.html` | 200 | 404 без данных | Требует данных/шаблон |
| `/smedorg.html` | 200 | 404 без данных | — |
| `/tfoms.html` | 200 | 404 без данных | — |
| `/ktfoms.html` | 200 | 404 без данных | — |
| `/press/` | 200 | 404 без данных | URL с завершающим `/` поддерживается regex, но нужен page |
| `/dispans/` | 200 | 404 без данных | — |
| `/virtual-reception/` | Форма с ESIA/капчей | 200, простая форма без вложений | Логика упрощена |
| `/rss.xml` | Валидный feed | Заглушка без items | Требуется реализация |
| `/search` | Форма + результаты, пагинация | Форма + топ-10, без пагинации | Логика упрощена |
| `/admin/login` | Форма входа | Отсутствует | Нет аутентификации |
| `/admin/cms/pages` | Полный UI | JSON заглушка | Требуется UI/CRUD |
| `/admin/cms/menus` | Полный UI | JSON заглушка | — |
| `/admin/cms/files` | Полный UI + upload | JSON заглушка | — |
| `/admin/cms/settings` | UI | JSON заглушка | — |
| `/admin/oms/virtual-reception` | UI | JSON заглушка | — |
| `/admin/oms/notifications` | UI | JSON заглушка | — |
| `/admin/oms/legacy` | Нет прямого | JSON счётчики | Только read-only |

## 3) Layout/Styles Parity
- Совпадает: подключены legacy CSS/JS (`public/legacy`), базовая сетка/шапка/топ-бар/коллаж, цвета/hover те же (пока стили не кастомизировались).
- Отличается/отсутствует:
  - Меню NAVBAR/SIDEBAR и breadcrumbs не отрисовываются без реальных данных; нет активных состояний.
  - Баннеры завязаны на setting `LEFT_SIDEBAR_BANNERS`, но в сидере заглушка; в импорте данных не подтягиваются автоматически.
  - Таб “последние новости/документы” рендерится, но данные берутся из новых сидов (не из legacy) и без картинок.
  - Нет проверки 1160px контейнера/скруглений через вьюал diff; требуется ручной осмотр.
  - Футер сверстан частично, не совпадает с legacy таблицами/картой.

## 4) Data/Content Parity
- Данные из дампов не импортируются автоматически: миграции создают структуру, но не вставляют INSERT. Нужен импорт содержимого (news/pages/menu/settings/files).
- Кодировки/HTML: контент выводится как есть через `v-html`; риск XSS/сломанных списков без санитайза.
- Изображения/uploads: пути в контенте/menus могут ссылаться на `/uploads/...` или внешние http://kubanoms.ru; в новом проекте uploads не развернуты, ссылки будут 404.
- Меню: sort_order/visible поля учтены, но отображение зависит от данных; нет выборки CURRENT_INFORMATION блока.

## 5) Functional Gaps
- Virtual Reception: нет вложений, нет ESIA/session проверки, нет rate_limits таблицы интеграции, только throttle middleware; statuses/ответы в админке отсутствуют.
- RSS: заглушка, нет выборки новостей.
- Search: нет пагинации/шаблона legacy, нет подсветки и сортировки, лимит 10.
- Sitemap: нет реализации (заглушка не сделана).
- Admin: нет UI (Filament/ Inertia), нет ролей/спатие, нет загрузки файлов/валидации.
- Legacy OMS back-office: только модели + JSON счётчики; UI отсутствует.

## 6) Bugs (с приоритетом)
- **P0**: Нет сидов/импорта контента → `/` и catch-all 404.  
  - Шаги: migrate, открыть `/`.  
  - Ожидание: home рендерится с данными.  
  - Фикс: добавить импорт INSERT из дампа или минимальный seed, который читает db dump, либо fallback страницы при пустых таблицах.  

- **P0**: Нет аутентификации/ролей (Breeze/spatie), /admin/login отсутствует.  
  - Шаги: открыть `/admin`.  
  - Ожидание: редирект на login, рабочий guard.  
  - Фикс: установить Breeze + spatie, настроить middleware, добавить UI.  

- **P1**: RSS заглушка без items.  
  - Шаги: GET /rss.xml.  
  - Ожидание: валидный feed с новостями.  
  - Фикс: выбрать news из cms_page page_of_type=2, собрать XML.  

- **P1**: Search упрощён и без пагинации/шаблона.  
  - Шаги: GET /search?q=...  
  - Ожидание: форма + результаты с пагинацией и layout как legacy.  
  - Фикс: добавить пагинацию и шаблон на базе legacy search.html.twig.  

Resolved:
- **P0**: миграции больше не зависят от `db/*.sql`; структура описана явными Laravel миграциями.

- **P1**: Virtual Reception — нет вложений/ESIA/подписи, rate_limits/sessions из legacy не используются.  
  - Шаги: открыть форму, отправить; attachments игнорируются.  
  - Ожидание: поддержка legacy потоков или явное отключение.  
  - Фикс: реализовать загрузку файлов, проверку sessions/rate_limits или задокументировать отказ.  

- **P1**: Catch-all может перехватить служебные URL (sitemap/esia-callback).  
  - Шаги: добавить маршрут `sitemap`, `esia-callback` — сейчас попадут в PageController.  
  - Фикс: добавить reserved список или отдельные маршруты.  

- **P1**: Контент через `v-html` без санитайза → риск XSS.  
  - Фикс: серверный sanitize allowlist или CSP + доменный фильтр.  

- **P2**: Layout parity неполный (breadcrumbs/menus/footers).  
  - Фикс: подтянуть данные, перенести Twig структуры в Vue компоненты.  

## 7) План фикса (по шагам)
1. **Стабилизировать миграции** (M): убрать внешнюю зависимость от файлов — либо конвертировать дампы в нормальные миграции, либо включить SQL в ресурсы и читать из config; добавить graceful skip + README.  
2. **Импорт данных** (M): реализовать seed/import INSERT из дампов (или artisan `legacy:import`) и проверку count; создать home/news/doc demo при пустоте.  
3. **Поднять auth/roles** (M): установить Breeze (Inertia) + spatie/permission, настроить /admin/login, guards, middleware.  
4. **CMS UI** (L): Filament или Inertia CRUD для pages/menus/files/settings; подключить загрузки с валидацией.  
5. **Public parity** (M): восстановить меню/crumbs/left banners, tabs на главной, search/sitemap/rss реализацию по legacy.  
6. **Virtual Reception** (L): добавить attachments, rate limit via DB, статус/ответы в админке; при необходимости ESIA/sessions совместимость.  
7. **Notifications/Legacy OMS** (M): админ read-only таблицы, фильтры; определить что реально используется.  
8. **Security hardening** (M): sanitize content, CSP headers, upload mime/size validation, avoid XSS.  
9. **Testing** (M): e2e/feature tests на public routes (status/meta/menus), admin CRUD smoke, VR submission, RSS XML validity.  
10. **Command legacy:audit** (S): artisan команда для сверки таблиц, опубликованных страниц, битых ссылок на uploads.  

## 8) Route-by-route parity checklist (см. таблицу выше)
- Требуется наполнение данными для всех публичных URL. Пока большинство 404 при пустой БД.

---
NB: автоматический визуальный diff не выполнялся; визуальные расхождения отмечены как необходимость ручной валидации после наполнения данными.***
